name: Direct Video Cut & Upload to Google Drive

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: "Direct video URL (mp4/mkv/webm/m3u8)"
        required: true
        type: string
      time_ranges:
        description: "HH:MM:SS - HH:MM:SS, multiple separated by comma"
        required: true
        type: string
      drive_folder:
        description: "Google Drive folder"
        required: false
        default: "video_cuts"
        type: string

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl

      - name: Setup rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${RCLONE_CONFIG}" > ~/.config/rclone/rclone.conf
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}

      - name: Download direct video
        run: |
          curl -L "${{ github.event.inputs.video_url }}" -o source.mp4

      - name: Cut video (filename based on time)
        run: |
          mkdir -p cuts
          IFS=',' read -ra SEGMENTS <<< "${{ github.event.inputs.time_ranges }}"

          for seg in "${SEGMENTS[@]}"; do
            START=$(echo "$seg" | awk -F'-' '{print $1}' | xargs)
            END=$(echo "$seg" | awk -F'-' '{print $2}' | xargs)

            SAFE_START=$(echo "$START" | tr ':' '-')
            SAFE_END=$(echo "$END" | tr ':' '-')

            OUTPUT="cuts/clip_${SAFE_START}_to_${SAFE_END}.mp4"

            echo "Cutting $START -> $END"
            ffmpeg -y \
              -i source.mp4 \
              -ss "$START" \
              -to "$END" \
              -c copy \
              "$OUTPUT"
          done

      - name: Upload to Google Drive
        run: |
          rclone copy cuts lasenameygd:${{ github.event.inputs.drive_folder }} \
            --progress
